var provData;function updateADR(){if(""!=jQuery("#budget").val()&&0!=jQuery("#budget").val()&&""!=jQuery("#budgetDays").val()&&0!=jQuery("#budgetDays").val()){var e=parseFloat(jQuery("#budget").val())/parseFloat(jQuery("#budgetDays").val());jQuery("#averageDailyRate").val(e.toFixed(2))}}function updateBudget(){if(""!=jQuery("#averageDailyRate").val()&&0!=jQuery("#averageDailyRate").val()&&""!=jQuery("#budgetDays").val()&&0!=jQuery("#budgetDays").val()){var e=parseFloat(jQuery("#budgetDays").val())*parseFloat(jQuery("#averageDailyRate").val());jQuery("#budget").val(e.toFixed(2))}}function createProvisionTr(e){var a=jQuery("<tr></tr>").addClass("provRow").attr("data-provRowId",e.provId),r=jQuery('<img align="absmiddle" src="images/b_drop.png">').addClass("deleteProvision_link").addClass("pointer").prop("title",smartyData.i18n_delete),t=jQuery('<img align="absmiddle" src="images/b_edit.png">').addClass("editProvision_link").addClass("pointer").prop("title",smartyData.i18n_edit),o=jQuery('<td style="width:38px;">').addClass("ui-state-error-text");o.append(r).append(" ").append(t);var d=jQuery("<span>").text(e.budget).addClass("provBudget"),i=jQuery("<span>").text(e.currency).addClass("provCurrency"),n=jQuery('<td style="text-align: right;">');return n.append(d).append(" ").append(i),a.append(o),a.append(jQuery("<td>").text(e.date).addClass("provDate")),a.append(jQuery("<td>").text(e.type).addClass("provType")),a.append(jQuery("<td>").text(e.budget_days).addClass("provBudgetDays")),a.append(n),a.append(jQuery("<td>").html(e.summary).addClass("provSummary")),e.is_checked?a.append(jQuery("<td>").html('<input type="checkbox" class="cbIsInCheckBudget" disabled="disabled" checked/>')):a.append(jQuery("<td>").html('<input type="checkbox" class="cbIsInCheckBudget" disabled="disabled" />')),e.csvFileLine&&a.attr("data-csvFileLine",e.csvFileLine),a}jQuery(document).ready(function(){var r;jQuery("#provisionsTable").on("click",".deleteProvision_link",function(e){e.preventDefault();var a=$(this).parents(".provRow"),r=$(a).attr("data-provRowId"),t=$(a).children(".provDate").text(),o=$(a).children(".provType").text(),d=$(a).children(".provBudgetDays").text(),i=$(a).find(".provBudget").text(),n=$(a).find(".provCurrency").text(),s=$(a).children(".provSummary").text(),u=smartyData.i18n_confirmDeleteProvision+"\n\n"+t+" "+o+"\n"+d+" "+smartyData.i18n_days+"\n"+i+" "+n+"\n\n"+s;confirm(u)&&$.ajax({url:smartyData.ajaxPage,type:"POST",dataType:"json",data:{action:"deleteProvision",cmdId:smartyData.cmdId,provRowId:r},success:function(e){null===e?(console.error("ERROR deleteProvision: no data"),alert("ERROR: Please contact your CodevTT administrator")):"SUCCESS"!==e.statusMsg?(console.error("ERROR Ajax statusMsg",e.statusMsg),alert(e.statusMsg)):jQuery(".provRow[data-provRowId='"+e.rowId+"']").remove()},error:function(e,a,r){console.error("ERROR deleteProvision errorThrown",r)}})}),jQuery("#provisionsTable").on("click",".editProvision_link",function(e){var a=$(this).parents(".provRow"),r=$(a).attr("data-provRowId"),t=$(a).children(".provDate").text(),o=$(a).children(".provType").attr("data-provTypeId"),d=$(a).children(".provBudgetDays").text(),i=$(a).find(".provBudget").text(),n=$(a).find(".provCurrency").text(),s=$(a).children(".provSummary").text(),u=$(a).find(".cbIsInCheckBudget").is(":checked");jQuery("#type").val(o),jQuery("#datepicker").val(t),jQuery("#budgetDays").val(d),jQuery("#budget").val(i),jQuery("#provisionCurrency").val(n),jQuery("#provisionCurrencyDisplayed").html(n),jQuery("#summary").val(s),jQuery("#cb_isInCheckBudget").prop("checked",u),jQuery("#addProvRowId").val(r),jQuery("#averageDailyRate").val(""),updateADR();var p=jQuery("#addProvision_dialog_form");p.dialog("option","title",smartyData.i18n_editProvision),jQuery("#addProvDlgAction").val("editProvision"),p.dialog("open")}),jQuery("#btAddProvision").click(function(e){var a=jQuery("#addProvision_dialog_form");a.dialog("option","title",smartyData.i18n_addProvision),jQuery("#addProvDlgAction").val("addProvision"),jQuery("#addProvRowId").val(0),jQuery("#datepicker").val(""),jQuery("#budgetDays").val(""),jQuery("#budget").val(""),jQuery("#summary").val(""),jQuery("#averageDailyRate").val(""),jQuery("#cb_isInCheckBudget").prop("checked",!1),a.dialog("open")}),jQuery("#addProvision_dialog_form").dialog({autoOpen:!1,resizable:!0,width:"auto",modal:!0,buttons:[{text:"OK",click:function(){var e=jQuery("#cb_isInCheckBudget").attr("checked")?1:0,a=jQuery("#formAddProvision");a.find("input[name=isInCheckBudget]").val(e),jQuery.ajax({url:smartyData.ajaxPage,type:"POST",dataType:"json",async:!1,data:a.serialize(),success:function(e){if("SUCCESS"===e.statusMsg)if(prov=e.provData,"editProvision"===e.action){var a=$(".provRow[data-provRowId="+prov.provId+"]");a.find(".provDate").text(prov.date),a.find(".provType").text(prov.type).attr("data-provTypeId",e.type_id),a.find(".provBudgetDays").text(prov.budget_days),a.find(".provBudget").text(prov.budget),a.find(".provCurrency").text(prov.currency),a.find(".provSummary").html(prov.summary),a.find(".cbIsInCheckBudget").prop("checked",prov.is_checked),a.css("background-color","#ccffcc")}else{var r=createProvisionTr(prov);r.css("background-color","#ffff99"),r.prependTo("#provisionsTable tbody")}else console.error("Ajax statusMsg",e.statusMsg),alert(e.statusMsg)},error:function(e,a,r){"Forbidden"===r?window.location=smartyData.page:(console.error(a,r),alert("ERROR: Please contact your CodevTT administrator"))}}),jQuery(this).dialog("close")}},{text:smartyData.i18n_cancel,click:function(){jQuery(this).dialog("close")}}]}),jQuery("#fileInput").on("change",function(e){r=e.target.files[0]}),jQuery("#btImportProvision").click(function(e){var a=new FormData;a.append("uploaded_csv",r),a.append("action","importProvisionCSV"),a.append("cmdid",smartyData.cmdId),jQuery.ajax({async:!1,type:"POST",url:smartyData.ajaxPage,data:a,processData:!1,contentType:!1,dataType:"json",success:function(e){"SUCCESS"===e.statusMsg?(provData=e.provData,jQuery.each(provData,function(e,a){var r=createProvisionTr(a);r.css("background-color","#ffff99"),r.prependTo("#provisionsTable tbody")})):(console.error("Ajax statusMsg",e.statusMsg),alert(e.statusMsg))},error:function(e,a,r){"Forbidden"===r?window.location=smartyData.page:(console.error(a,r),alert("ERROR: Please contact your CodevTT administrator"))}})}),jQuery("#provisionCurrency").on("change",function(e){var a=jQuery("#provisionCurrency").val();jQuery("#provisionCurrencyDisplayed").html(a)}),jQuery("#budgetDays").keyup(function(e){updateBudget()}),jQuery("#averageDailyRate").keyup(function(e){updateBudget()}),jQuery("#budget").keyup(function(e){updateADR()}),jQuery("#type").change(function(){var e=jQuery("#type").val()!=smartyData.cmdProvisionTypeMngt;jQuery("#cb_isInCheckBudget").prop("checked",e)})});